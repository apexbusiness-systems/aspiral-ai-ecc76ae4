import{j as e}from"./react-query-1zeL9f71.js";import{r as s}from"./react-vendor-BIu81k28.js";import{j as a,V as r,e as t,C as n,a as i,d as o,f as l,g as c,L as d,I as u,W as m,i as p,r as g,P as b,Y as f,D as _,E as h,$ as x,y as w}from"./index-C2YmphIk.js";import{C as v,a as y}from"./radix-forms-KIAltt28.js";import{M as S}from"./message-square-DLm0ufib.js";import{R as k}from"./refresh-cw-BNU7USx8.js";import{u as j}from"./react-router-BwMFiyVe.js";import"./radix-primitives-Di8eIdiq.js";import"./radix-overlays-68Wd_bDx.js";import"./supabase-Ds_TnZEi.js";const N=s.forwardRef(({className:s,...t},n)=>e.jsx(v,{ref:n,className:a("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),...t,children:e.jsx(y,{className:a("flex items-center justify-center text-current"),children:e.jsx(r,{className:"h-4 w-4"})})}));N.displayName=v.displayName;const C=["javascript:","data:","vbscript:","file:","about:"];function $(e,s){if(!function(e,s=["http:","https:","mailto:","tel:"]){if(!e||"string"!=typeof e)return!1;const a=e.toLowerCase().trim();for(const n of C)if(a.startsWith(n))return t.report({type:"error",message:`Blocked XSS attempt via dangerous URL protocol: ${n}`,timestamp:(new Date).toISOString(),url:window.location.href,userAgent:navigator.userAgent,environment:t.getEnvironment(),metadata:{blockedUrl:e.substring(0,100),detectedProtocol:n}}),!1;try{const a=new URL(e,window.location.href).protocol.toLowerCase();for(const s of C)if(a===s)return t.report({type:"error",message:`Blocked XSS attempt via dangerous URL protocol after parsing: ${a}`,timestamp:(new Date).toISOString(),url:window.location.href,userAgent:navigator.userAgent,environment:t.getEnvironment(),metadata:{blockedUrl:e.substring(0,100),parsedProtocol:a}}),!1;return!!s.includes(a)||(t.report({type:"error",message:`Blocked navigation to disallowed URL protocol: ${a}`,timestamp:(new Date).toISOString(),url:window.location.href,userAgent:navigator.userAgent,environment:t.getEnvironment(),metadata:{blockedUrl:e,protocol:a,allowedProtocols:s.join(", ")}}),!1)}catch(r){return t.report({type:"error",message:`Invalid URL format: ${r instanceof Error?r.message:"Unknown error"}`,stack:r instanceof Error?r.stack:void 0,timestamp:(new Date).toISOString(),url:window.location.href,userAgent:navigator.userAgent,environment:t.getEnvironment(),metadata:{attemptedUrl:e}}),!1}}(e,s))return!1;try{const s=window.open(e,"_blank");return s&&(s.opener=null),!0}catch(a){return t.report({type:"error",message:`Failed to open URL: ${a instanceof Error?a.message:"Unknown error"}`,stack:a instanceof Error?a.stack:void 0,timestamp:(new Date).toISOString(),url:window.location.href,userAgent:navigator.userAgent,environment:t.getEnvironment(),metadata:{targetUrl:e}}),!1}}function I(){j();const[a,r]=s.useState(!1),[t,v]=s.useState([]),[y,C]=s.useState({tenant_id:"",business_name:"",legal_address:"",contact_email:"",existing_numbers:"",want_sms:!1,fallback_e164:""}),I=e=>{const s=(new Date).toLocaleTimeString();v(a=>[...a,`[${s}] ${e}`])},A=async()=>{var e;r(!0),v([]);try{I("Initializing client onboarding...");y.existing_numbers.split(",").map(e=>e.trim()).filter(e=>e);I("Creating/retrieving Twilio subaccount...");const{data:s,error:a}=await w.functions.invoke("ops-twilio-ensure-subaccount",{body:{tenant_id:y.tenant_id,business_name:y.business_name}});if(a){if(null==(e=a.message)?void 0:e.includes("Missing Twilio credentials"))throw new Error("Twilio credentials not configured. Please add TWILIO_ACCOUNT_SID and TWILIO_AUTH_TOKEN to edge function secrets.");throw a}if(I(`âœ“ Subaccount ready: ${s.subaccount_sid}`),y.want_sms){I("Setting up Messaging Service for SMS...");const{data:e,error:a}=await w.functions.invoke("ops-twilio-ensure-messaging-service",{body:{tenant_id:y.tenant_id,business_name:y.business_name,subaccount_sid:s.subaccount_sid}});if(a)throw a;I(`âœ“ Messaging Service ready: ${e.messaging_service_sid}`)}I("âœ“ Client initialization complete!"),x.success("Client initialized successfully")}catch(s){console.error("Initialization error:",s),I(`âœ— Error: ${s.message}`),x.error("Failed to initialize client")}finally{r(!1)}};return e.jsxs("div",{className:"container mx-auto p-6 max-w-5xl",children:[e.jsxs("div",{className:"mb-6 text-center sm:text-left",children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight text-foreground",children:"Add Number"}),e.jsx("p",{className:"text-muted-foreground",children:"Provision or port a new number into the TradeLine 24/7 platform."})]}),e.jsxs(n,{children:[e.jsxs(i,{children:[e.jsx(o,{children:"Add Number"}),e.jsx(l,{children:"Initialize client account and select onboarding track"})]}),e.jsxs(c,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"tenant_id",children:"Tenant ID *"}),e.jsx(u,{id:"tenant_id",placeholder:"internal-client-id",value:y.tenant_id,onChange:e=>C({...y,tenant_id:e.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"business_name",children:"Business Name *"}),e.jsx(u,{id:"business_name",placeholder:"Acme Corporation",value:y.business_name,onChange:e=>C({...y,business_name:e.target.value})})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(d,{htmlFor:"legal_address",children:"Legal Address *"}),e.jsx(u,{id:"legal_address",placeholder:"123 Main St, City, Province, Postal",value:y.legal_address,onChange:e=>C({...y,legal_address:e.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"contact_email",children:"Contact Email *"}),e.jsx(u,{id:"contact_email",type:"email",placeholder:"contact@example.com",value:y.contact_email,onChange:e=>C({...y,contact_email:e.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"fallback_e164",children:"Fallback Number *"}),e.jsx(u,{id:"fallback_e164",placeholder:"+14031234567",value:y.fallback_e164,onChange:e=>C({...y,fallback_e164:e.target.value})})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(d,{htmlFor:"existing_numbers",children:"Existing Numbers (comma-separated)"}),e.jsx(u,{id:"existing_numbers",placeholder:"+14031111111, +14032222222",value:y.existing_numbers,onChange:e=>C({...y,existing_numbers:e.target.value})})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(N,{id:"want_sms",checked:y.want_sms,onCheckedChange:e=>C({...y,want_sms:!0===e})}),e.jsx(d,{htmlFor:"want_sms",className:"cursor-pointer",children:"Enable SMS on existing numbers"})]})]}),e.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between rounded-lg border border-dashed border-muted-foreground/40 bg-muted/40 p-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("h3",{className:"text-base font-semibold flex items-center gap-2",children:[e.jsx(m,{className:"h-4 w-4"}),"One-Click Number Onboarding"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Instantly provisions a Twilio subaccount, purchases a local number, and wires default voice/SMS webhooks."})]}),e.jsxs(p,{onClick:async()=>{var e;if(y.tenant_id&&y.business_name){r(!0),v([]);try{I("Provisioning telephony subaccount and number (one-click)...");const s=null==(e=y.fallback_e164)?void 0:e.replace(/[^0-9]/g,""),a=s&&s.length>=10?s.slice(-10,-7):void 0,{data:r,error:t}=await w.functions.invoke("telephony-onboard",{body:{org_id:y.tenant_id,business_name:y.business_name,area_code:a,country:"CA"}});if(t)throw new Error(t.message||"Failed to complete one-click provisioning");I(`âœ… Subaccount ready: ${null==r?void 0:r.subaccount_sid}`),I(`âœ… Number live: ${null==r?void 0:r.phone_number}`),(null==r?void 0:r.voice_url)&&I(`ðŸ”” Voice webhook: ${r.voice_url}`),(null==r?void 0:r.sms_url)&&I(`ðŸ’¬ SMS webhook: ${r.sms_url}`),x.success((null==r?void 0:r.phone_number)?`Number ${r.phone_number} is live`:"Number is live")}catch(s){console.error("One-click onboarding error:",s),I(`âœ— Error: ${s.message}`),x.error(s.message||"Failed to complete one-click provisioning")}finally{r(!1)}}else x.error("Tenant ID and business name are required for one-click provisioning")},disabled:a||!y.tenant_id||!y.business_name,className:"md:w-auto",children:[a?e.jsx(g,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(m,{className:"mr-2 h-4 w-4"}),"Add Number (One-Click)"]})]}),e.jsxs("div",{className:"border-t pt-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Select Onboarding Track"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs(p,{onClick:async()=>{if(y.fallback_e164){r(!0),v([]);try{I("Initializing client..."),await A(),I("Executing Quick-Start Forward flow...");const e=y.fallback_e164.substring(2,5),{data:s,error:a}=await w.functions.invoke("ops-twilio-quickstart-forward",{body:{tenant_id:y.tenant_id,business_name:y.business_name,fallback_e164:y.fallback_e164,area_code:e,contact_email:y.contact_email}});if(a)throw a;if(I(`âœ… Quick-Start: Purchased number ${s.phone_number}`),I("âœ… Configured webhooks and failover"),I("âœ… Added to Messaging Service"),s.forwarding_kit_url&&I(`âœ… Forwarding Kit ready: ${s.forwarding_kit_url}`),x.success("Quick-Start Forward complete!"),s.forwarding_kit_url){$(s.forwarding_kit_url)||x.error("Invalid forwarding kit URL. Please contact support.")}}catch(e){console.error("Quick-Start Forward error:",e),I(`âœ— Error: ${e.message}`),x.error("Failed to complete Quick-Start Forward")}finally{r(!1)}}else x.error("Fallback number is required for Quick-Start Forward")},disabled:a||!y.tenant_id||!y.business_name||!y.fallback_e164,className:"h-24 flex-col gap-2",children:[e.jsx(b,{className:"h-6 w-6"}),e.jsx("span",{children:"Quick-Start Forward"}),e.jsx("span",{className:"text-xs opacity-80",children:"Buy + Wire + Kit"})]}),e.jsxs(p,{onClick:async()=>{if(y.existing_numbers){r(!0),v([]);try{I("Initializing client for Hosted SMS..."),await A(),I("Processing Hosted SMS requests...");const e=y.existing_numbers.split(",").map(e=>e.trim()).filter(e=>e);if(0===e.length)throw new Error("No valid phone numbers provided");const{data:s}=await w.functions.invoke("ops-twilio-ensure-subaccount",{body:{tenant_id:y.tenant_id,business_name:y.business_name}});for(const a of e){I(`ðŸ“± Submitting Hosted SMS order for ${a}...`);const{data:e,error:r}=await w.functions.invoke("ops-twilio-hosted-sms",{body:{phoneNumber:a,tenant_id:y.tenant_id,business_name:y.business_name,legal_address:y.legal_address,contact_email:y.contact_email,subaccount_sid:s.subaccount_sid}});if(r)throw r;I(`âœ… Hosted SMS order created for ${a}`),I(`ðŸ“§ LOA email sent to ${y.contact_email}`),I(`ðŸ”‘ Order SID: ${e.orderSid}`),I(`ðŸ“‹ Status: ${e.status}`),e.loaUrl&&I(`ðŸ“„ LOA Document: ${e.loaUrl}`),I("âš ï¸ Client must sign LOA and complete ownership verification"),I("â±ï¸ Processing typically takes 1-2 business days"),I("")}I("âœ… All Hosted SMS orders submitted successfully"),I("ðŸ“Œ Next steps:"),I("  1. Client will receive LOA email from Twilio"),I("  2. Client must sign LOA electronically"),I("  3. Twilio may call for ownership verification"),I("  4. Once approved, numbers will be SMS-enabled"),I("  5. Numbers will be added to Messaging Service automatically"),x.success("Hosted SMS orders submitted successfully")}catch(e){console.error("Hosted SMS error:",e),I(`âœ— Error: ${e.message}`),x.error("Failed to submit Hosted SMS orders")}finally{r(!1)}}else x.error("Please provide at least one existing number for Hosted SMS")},disabled:a||!y.tenant_id||!y.business_name,variant:"secondary",className:"h-24 flex-col gap-2",children:[e.jsx(S,{className:"h-6 w-6"}),e.jsx("span",{children:"Hosted SMS"}),e.jsx("span",{className:"text-xs opacity-80",children:"Use existing numbers"})]}),e.jsxs(p,{onClick:async()=>{var e;if(y.existing_numbers)if(y.fallback_e164){r(!0),v([]);try{I("Initializing client for Full Port..."),await A(),I("Processing port orders...");const s=y.existing_numbers.split(",").map(e=>e.trim()).filter(e=>e);if(0===s.length)throw new Error("No valid phone numbers provided");const{data:a}=await w.functions.invoke("ops-twilio-ensure-subaccount",{body:{tenant_id:y.tenant_id,business_name:y.business_name}});for(const r of s){I(`ðŸ“ž Initiating port order for ${r}...`);const{data:s,error:t}=await w.functions.invoke("ops-twilio-create-port",{body:{phoneNumber:r,tenant_id:y.tenant_id,business_name:y.business_name,legal_address:y.legal_address,contact_email:y.contact_email,subaccount_sid:a.subaccount_sid,authorized_person_name:y.business_name,fallback_e164:y.fallback_e164,current_carrier:"Unknown"}});if(t)throw t;I(`âœ… Port order created for ${r}`),I(`ðŸ”‘ Port Order SID: ${s.portOrderSid}`),I(`ðŸ“… Estimated FOC Date: ${new Date(s.estimatedFocDate).toLocaleDateString()}`),s.temporaryDid&&(I(`ðŸ“± Temporary DID provisioned: ${s.temporaryDid}`),I(`â†ªï¸  Forward ${r} to ${s.temporaryDid} immediately`)),s.quickStartCreated&&I("âš¡ Quick-Start forwarding kit auto-generated"),I(`ðŸ“§ LOA email sent to ${y.contact_email}`),I("âš™ï¸  Webhooks pre-provisioned for port completion"),I(""),I("ðŸ“‹ Next Steps:"),null==(e=s.nextSteps)||e.forEach(e=>{I(`  â€¢ ${e}`)}),I("")}I("âœ… All port orders submitted successfully"),I(""),I("ðŸŽ¯ Port Process Timeline:"),I("  1. Client signs LOA (today)"),I("  2. Twilio processes port request (1-2 days)"),I("  3. Losing carrier confirms (3-5 days)"),I("  4. FOC date reached - port completes (7-10 days)"),I("  5. Number goes live on Twilio automatically"),I("  6. Remove temporary forwarding"),I(""),I("âš ï¸  During port process:"),I("  â€¢ Temporary forwarding ensures no missed calls"),I("  â€¢ Voice & SMS will work via forwarding"),I("  â€¢ Monitor port status daily"),x.success("Port orders created successfully")}catch(s){console.error("Port order error:",s),I(`âœ— Error: ${s.message}`),x.error("Failed to create port orders")}finally{r(!1)}}else x.error("Fallback number is required for temporary forwarding during port");else x.error("Please provide the phone number(s) to port")},disabled:a||!y.tenant_id||!y.business_name,variant:"outline",className:"h-24 flex-col gap-2",children:[e.jsx(k,{className:"h-6 w-6"}),e.jsx("span",{children:"Full Port"}),e.jsx("span",{className:"text-xs opacity-80",children:"Port existing numbers"})]})]})]}),e.jsxs("div",{className:"border-t pt-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Trust & Reputation Setup"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Configure Trust Hub, A2P 10DLC, STIR/SHAKEN, and CNAM caller ID (can run in parallel with onboarding tracks)"}),e.jsxs(p,{onClick:async()=>{if(y.existing_numbers||y.fallback_e164){r(!0),v([]);try{I("Initializing Trust Hub and reputation setup...");const e=y.existing_numbers?y.existing_numbers.split(",")[0].trim():y.fallback_e164,{data:s}=await w.functions.invoke("ops-twilio-ensure-subaccount",{body:{tenant_id:y.tenant_id,business_name:y.business_name}});I(`Setting up Trust Hub for ${e}...`);const{data:a,error:r}=await w.functions.invoke("ops-twilio-trust-setup",{body:{tenant_id:y.tenant_id,business_name:y.business_name,legal_address:y.legal_address,phone_number:e,subaccount_sid:s.subaccount_sid,country_code:"US",contact_email:y.contact_email}});if(r)throw r;a.trustHubProfileSid&&I(`âœ… Trust Hub Business Profile created: ${a.trustHubProfileSid}`),a.a2pBrandSid&&a.a2pCampaignSid&&(I("âœ… Registered for 10DLC (US A2P)"),I(`   Brand SID: ${a.a2pBrandSid}`),I(`   Campaign SID: ${a.a2pCampaignSid}`)),a.voiceIntegrityEnabled&&I("âœ… Enabled STIR/SHAKEN voice attestation"),a.cnamSet&&I(`âœ… CNAM Caller ID set to "${y.business_name}"`),I(""),I("ðŸ“‹ Reputation Features Configured:"),I("  â€¢ Trust Hub Business Profile âœ“"),a.a2pBrandSid&&I("  â€¢ A2P 10DLC Registration âœ“"),a.voiceIntegrityEnabled&&I("  â€¢ STIR/SHAKEN Attestation âœ“"),a.cnamSet&&I("  â€¢ Caller ID Name Display âœ“"),I(""),I("âœ… Trust and reputation setup complete!"),x.success("Trust Hub and reputation setup complete!")}catch(e){console.error("Trust Setup error:",e),I(`âœ— Error: ${e.message}`),x.error("Failed to complete Trust Setup")}finally{r(!1)}}else x.error("Please provide a phone number for Trust Setup")},disabled:a||!y.tenant_id||!y.business_name,variant:"secondary",className:"w-full md:w-auto",children:[a?e.jsx(g,{className:"mr-2 h-4 w-4 animate-spin"}):null,"Setup Trust & Reputation"]})]}),e.jsxs("div",{className:"border-t pt-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Billing & Usage Mapping"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Map phone numbers to tenant for usage tracking and billing (initialize usage counters for voice minutes and SMS counts)"}),e.jsxs(p,{onClick:async()=>{if(y.existing_numbers||y.fallback_e164){r(!0),v([]);try{I("Initializing billing mapping...");const e=y.existing_numbers?y.existing_numbers.split(",")[0].trim():y.fallback_e164;I(`Mapping ${e} to tenant for usage tracking...`);const{data:s,error:a}=await w.functions.invoke("ops-map-number-to-tenant",{body:{tenant_id:y.tenant_id,phone_number:e,twilio_number_sid:`PN${Date.now()}`,number_type:"both"}});if(a)throw a;I(`âœ… ${s.evidence||"Mapped number to tenant and initialized usage counters"}`),I(""),I("ðŸ“Š Billing Features Configured:"),I("  â€¢ Phone number mapped to tenant âœ“"),I("  â€¢ Usage counters initialized âœ“"),I("  â€¢ Billing period set to monthly âœ“"),I("  â€¢ Ready to track voice minutes âœ“"),I("  â€¢ Ready to track SMS counts âœ“"),I(""),I("ðŸ’° Usage will be automatically logged for:"),I("  â€¢ Inbound voice calls"),I("  â€¢ Outbound voice calls"),I("  â€¢ Inbound SMS messages"),I("  â€¢ Outbound SMS messages"),x.success("Number mapped for billing successfully!")}catch(e){console.error("Billing mapping error:",e),I(`âœ— Error: ${e.message}`),x.error("Failed to map number for billing")}finally{r(!1)}}else x.error("Please provide a phone number to map for billing")},disabled:a||!y.tenant_id||!y.existing_numbers&&!y.fallback_e164,variant:"secondary",className:"w-full md:w-auto",children:[a?e.jsx(g,{className:"mr-2 h-4 w-4 animate-spin"}):null,e.jsx(f,{className:"mr-2 h-4 w-4"}),"Map Number for Billing"]})]}),t.length>0&&e.jsx(_,{children:e.jsx(h,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Onboarding Log"}),e.jsx("div",{className:"bg-muted p-3 rounded font-mono text-xs max-h-64 overflow-y-auto",children:t.map((s,a)=>e.jsx("div",{className:"py-1",children:s},a))})]})})}),a&&e.jsxs("div",{className:"flex items-center justify-center gap-2 text-muted-foreground",children:[e.jsx(g,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{children:"Processing..."})]})]})]})]})}export{I as default};
