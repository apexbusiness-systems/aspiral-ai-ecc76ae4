var e=Object.defineProperty,t=(t,a,s)=>((t,a,s)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s)(t,"symbol"!=typeof a?a+"":a,s);const a={maxRetries:5,retryDelayMs:1e3,maxRetryDelayMs:3e4,queueSize:50,batchIntervalMs:5e3,healthCheckIntervalMs:3e4,enableFallback:!0};class s{constructor(e={}){t(this,"config"),t(this,"saveQueue",[]),t(this,"pendingSaves",new Map),t(this,"healthCheckInterval",null),t(this,"batchInterval",null),t(this,"isHealthy",!0),t(this,"consecutiveFailures",0),t(this,"lastSuccessTime",Date.now()),this.config={...a,...e},this.initialize()}initialize(){this.startHealthMonitoring(),this.startBatchProcessing(),this.restoreQueue(),this.setupNetworkListeners(),this.setupVisibilityListeners(),this.config}async save(e,t="direct"){const a={id:this.generateAttemptId(),timestamp:Date.now(),data:e,retries:0,strategy:t,status:"pending"};try{if("direct"===t||"fallback"===t){if(await this.attemptDirectSave(a))return this.recordSuccess(),!0}return"queue"===t||"batch"===t?(this.queueSave(a),!0):await this.retrySave(a)}catch(s){return console.error("[Lovable Failsafe] Save failed:",s),this.recordFailure(),this.queueSave(a),async function(e,t){try{const s="https://hysvqdwmhxnblxfqnszn.supabase.co/functions/v1";let i={};try{i=e&&"object"==typeof e?JSON.parse(JSON.stringify(e,Object.getOwnPropertyNames(e))):{message:String(e)}}catch(a){i={message:e instanceof Error?e.message:String(e)}}const r={org_id:t??null,error_id:crypto.randomUUID(),error_type:(null==e?void 0:e.type)??(e instanceof Error?e.name:"unknown"),payload:i,user_agent:navigator.userAgent};await fetch(`${s}/ops-error-intake`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})}catch(s){try{const t="error_reporting_failures",a=JSON.parse(localStorage.getItem(t)||"[]"),i=e=>e instanceof Error?e.message:String(e&&"object"==typeof e&&"message"in e?e.message:e);a.push({originalError:i(e),reportingError:i(s),timestamp:(new Date).toISOString(),userAgent:(null==navigator?void 0:navigator.userAgent)||"unknown"});const r=a.slice(-10);localStorage.setItem(t,JSON.stringify(r))}catch(i){console.error("[reportError] Failed to report error and store fallback:",{originalError:e,reportingError:s,storageError:i})}}}(s,"lovable-save-failsafe"),!1}}async attemptDirectSave(e){try{if(!this.isHealthy&&0===e.retries)return console.warn("[Lovable Failsafe] System unhealthy, queuing save"),!1;if(!this.checkLovableAvailability())return console.warn("[Lovable Failsafe] Lovable not available, queuing save"),!1;return!!(await this.executeLovableSave(e.data))&&(e.status="success",this.pendingSaves.delete(e.id),!0)}catch(t){return console.error("[Lovable Failsafe] Direct save attempt failed:",t),!1}}async executeLovableSave(e){var t;try{if(!this.isLovableEnvironment())return console.warn("[Lovable Failsafe] Not in Lovable environment, skipping save"),!1;const a=null==(t=window.lovable)?void 0:t.save;return a&&"function"==typeof a?(await a(e),!0):await this.fallbackGitHubSave(e)}catch(a){return console.error("[Lovable Failsafe] Execute save failed:",a),!1}}async fallbackGitHubSave(e){try{return console.warn("[Lovable Failsafe] GitHub fallback not fully implemented, queuing save"),!1}catch(t){return console.error("[Lovable Failsafe] GitHub fallback failed:",t),!1}}async retrySave(e){if(e.retries>=this.config.maxRetries)return console.error("[Lovable Failsafe] Max retries reached for attempt:",e.id),e.status="failed",this.queueSave(e),!1;e.retries++,e.status="retrying";const t=Math.min(this.config.retryDelayMs*Math.pow(2,e.retries-1),this.config.maxRetryDelayMs);e.id,e.retries,this.config.maxRetries,await this.sleep(t);const a=this.getNextStrategy(e.strategy);return await this.save(e.data,a)}getNextStrategy(e){const t=["direct","queue","batch","fallback"],a=t.indexOf(e);return t[(a+1)%t.length]}queueSave(e){this.saveQueue.length>=this.config.queueSize&&(console.warn("[Lovable Failsafe] Queue full, removing oldest save"),this.saveQueue.shift()),this.saveQueue.push(e),this.pendingSaves.set(e.id,e),this.persistQueue(),e.id,this.saveQueue.length}async processBatch(){if(0===this.saveQueue.length)return;if(!this.isHealthy)return void console.warn("[Lovable Failsafe] System unhealthy, skipping batch processing");const e=[...this.saveQueue];this.saveQueue=[];for(const a of e)try{!(await this.attemptDirectSave(a))&&a.retries<this.config.maxRetries&&this.queueSave(a)}catch(t){console.error("[Lovable Failsafe] Batch save failed:",t),a.retries<this.config.maxRetries&&this.queueSave(a)}this.persistQueue()}startHealthMonitoring(){this.healthCheckInterval=window.setInterval(()=>{this.performHealthCheck()},this.config.healthCheckIntervalMs)}async performHealthCheck(){try{const e=this.isHealthy,t=navigator.onLine,a=this.checkLovableAvailability(),s=this.consecutiveFailures>10,i=Date.now()-this.lastSuccessTime,r=i>3e5;this.isHealthy=t&&a&&!s&&!r,e!==this.isHealthy&&(this.isHealthy,this.isHealthy&&this.processBatch()),this.isHealthy||console.warn("[Lovable Failsafe] System unhealthy:",{isOnline:t,isLovableAvailable:a,consecutiveFailures:this.consecutiveFailures,timeSinceLastSuccess:i})}catch(e){console.error("[Lovable Failsafe] Health check failed:",e),this.isHealthy=!1}}checkLovableAvailability(){try{if(!this.isLovableEnvironment())return!1;const e=window.lovable;if(!e)return!1;return"function"==typeof e.save}catch(e){return console.error("[Lovable Failsafe] Lovable availability check failed:",e),!1}}isLovableEnvironment(){try{const e=window.location.hostname,t=e.includes("lovable")||e.includes("lovable.dev"),a=void 0!==window.lovable,s=navigator.userAgent.includes("Lovable");return t||a||s}catch(e){return!1}}startBatchProcessing(){this.batchInterval=window.setInterval(()=>{this.isHealthy&&this.saveQueue.length>0&&this.processBatch()},this.config.batchIntervalMs)}setupNetworkListeners(){window.addEventListener("online",()=>{this.isHealthy=!0,this.processBatch()}),window.addEventListener("offline",()=>{console.warn("[Lovable Failsafe] Network offline"),this.isHealthy=!1})}setupVisibilityListeners(){document.addEventListener("visibilitychange",()=>{!document.hidden&&this.isHealthy&&this.saveQueue.length>0&&this.processBatch()})}persistQueue(){try{const e=this.saveQueue.map(e=>({id:e.id,timestamp:e.timestamp,data:e.data,retries:e.retries,strategy:e.strategy}));localStorage.setItem("lovable-save-queue",JSON.stringify(e))}catch(e){console.error("[Lovable Failsafe] Failed to persist queue:",e)}}restoreQueue(){try{const e=localStorage.getItem("lovable-save-queue");if(!e)return;const t=JSON.parse(e);Array.isArray(t)&&(this.saveQueue=t.map(e=>({...e,status:"pending"})),this.saveQueue.forEach(e=>{this.pendingSaves.set(e.id,e)}),this.saveQueue.length,localStorage.removeItem("lovable-save-queue"))}catch(e){console.error("[Lovable Failsafe] Failed to restore queue:",e),localStorage.removeItem("lovable-save-queue")}}recordSuccess(){this.consecutiveFailures=0,this.lastSuccessTime=Date.now(),this.isHealthy=!0}recordFailure(){this.consecutiveFailures++,this.consecutiveFailures>5&&(this.isHealthy=!1)}generateAttemptId(){return`save-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}sleep(e){return new Promise(t=>setTimeout(t,e))}getStatus(){return{isHealthy:this.isHealthy,queueSize:this.saveQueue.length,pendingSaves:this.pendingSaves.size,consecutiveFailures:this.consecutiveFailures,lastSuccessTime:this.lastSuccessTime,timeSinceLastSuccess:Date.now()-this.lastSuccessTime}}async forceProcessQueue(){await this.processBatch()}clearQueue(){this.saveQueue=[],this.pendingSaves.clear(),localStorage.removeItem("lovable-save-queue")}destroy(){null!==this.healthCheckInterval&&clearInterval(this.healthCheckInterval),null!==this.batchInterval&&clearInterval(this.batchInterval)}}let i=null;function r(e){return i||(i=new s(e)),i}if("undefined"!=typeof window){const e=window.location.hostname;(e.includes("lovable")||e.includes("lovable.dev"))&&r()}export{r as initializeLovableFailsafe};
