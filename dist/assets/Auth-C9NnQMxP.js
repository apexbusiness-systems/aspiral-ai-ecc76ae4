import{j as e}from"./react-query-1zeL9f71.js";import{r as s}from"./react-vendor-BIu81k28.js";import{y as a,e as r,z as t,A as n,C as i,a as o,d as l,f as c,g as d,D as u,E as m,L as h,I as g,i as p,r as w,F as v}from"./index-C2YmphIk.js";import{T as x,a as f,b as y,c as j}from"./tabs-WdgLnVcG.js";import{u as b}from"./react-router-BwMFiyVe.js";import"./radix-primitives-Di8eIdiq.js";import"./radix-overlays-68Wd_bDx.js";import"./supabase-Ds_TnZEi.js";import"./radix-forms-KIAltt28.js";const S=()=>{const[S,k]=s.useState(""),[N,P]=s.useState(""),[A,E]=s.useState(""),[B,T]=s.useState(!1),[V,C]=s.useState(null),[I,D]=s.useState(null),[q,$]=s.useState(null),[O,F]=s.useState(null),[U,L]=s.useState(""),[W,z]=s.useState(!1),[G,Z]=s.useState(!1),R=b(),{validatePassword:_}=(()=>{const e=s.useCallback(async e=>{try{if(!e||e.length<1)return{isBreached:!1,message:"Password required"};const{data:s,error:t}=await a.functions.invoke("check-password-breach",{body:{password:e}});return t?(r.report({type:"error",message:`Password breach check error: ${t.message}`,timestamp:(new Date).toISOString(),url:window.location.href,userAgent:navigator.userAgent,environment:r.getEnvironment(),metadata:{error:t}}),{isBreached:!1,message:"Password check service temporarily unavailable",error:t.message}):{isBreached:(null==s?void 0:s.isBreached)||!1,message:(null==s?void 0:s.message)||"Password check completed",error:null==s?void 0:s.error}}catch(V){return r.report({type:"error",message:`Password security check failed: ${V instanceof Error?V.message:"Unknown error"}`,stack:V instanceof Error?V.stack:void 0,timestamp:(new Date).toISOString(),url:window.location.href,userAgent:navigator.userAgent,environment:r.getEnvironment(),metadata:{error:V}}),{isBreached:!1,message:"Password check service error",error:V instanceof Error?V.message:"Unknown error"}}},[]),t=s.useCallback(e=>{if(e.length<8)return{isValid:!1,strength:"Too short",message:"Password must be at least 8 characters long"};const s=[/[a-z]/.test(e),/[A-Z]/.test(e),/\d/.test(e),/[!@#$%^&*(),.?":{}|<>]/.test(e)].filter(Boolean).length;return s<3?{isValid:!1,strength:"Too weak",message:"Password must contain at least 3 of: lowercase, uppercase, number, special character"}:{isValid:!0,strength:4===s?"Very strong":"Good"}},[]),n=s.useCallback(async s=>{const a=t(s);if(!a.isValid)return{isValid:!1,strength:a.strength,isBreached:!1,message:a.message};const r=await e(s);return{isValid:!r.isBreached,strength:a.strength,isBreached:r.isBreached,message:r.isBreached?r.message:void 0}},[t,e]);return{checkPasswordBreach:e,validatePasswordStrength:t,validatePassword:n}})();s.useEffect(()=>{if(!t||!a)return T(!1),()=>{};const{data:{subscription:e}}=a.auth.onAuthStateChange((e,s)=>{F(s),$((null==s?void 0:s.user)??null),(null==s?void 0:s.user)&&R(n.dashboard)});return a.auth.getSession().then(({data:{session:e},error:s})=>{var t,i;if((null==(t=null==s?void 0:s.message)?void 0:t.includes("malformed"))||(null==(i=null==s?void 0:s.message)?void 0:i.includes("invalid")))return r.report({type:"error",message:`Auth: Detected malformed token, clearing session: ${s.message}`,timestamp:(new Date).toISOString(),url:window.location.href,userAgent:navigator.userAgent,environment:r.getEnvironment()}),a.auth.signOut().catch(()=>{}),F(null),void $(null);F(e),$((null==e?void 0:e.user)??null),(null==e?void 0:e.user)&&R(n.dashboard)}).catch(e=>{r.report({type:"error",message:`Auth: Session check failed: ${(null==e?void 0:e.message)||e}`,stack:null==e?void 0:e.stack,timestamp:(new Date).toISOString(),url:window.location.href,userAgent:navigator.userAgent,environment:r.getEnvironment()}),a.auth.signOut().catch(()=>{}),F(null),$(null)}),()=>e.unsubscribe()},[R]);const H=async e=>{P(e),z(!0),Z(!1);try{const s=(e=>{if(e.length<8)return{isValid:!1,strength:"Too short",message:"Password must be at least 8 characters long"};const s=[/[a-z]/.test(e),/[A-Z]/.test(e),/\d/.test(e),/[!@#$%^&*(),.?":{}|<>]/.test(e)].filter(Boolean).length;return s<3?{isValid:!1,strength:"Weak",message:"Password must contain at least 3 of: lowercase, uppercase, number, special character"}:{isValid:!0,strength:4===s?"Strong":"Good"}})(e);if(L(s.strength),s.isValid&&e.length>=8){const s=await _(e);L(s.strength),Z(s.isBreached),s.isBreached?C(s.message||"This password appears in known data breaches"):C(null)}}catch(s){r.report({type:"error",message:`Password validation error: ${s}`,stack:s instanceof Error?s.stack:void 0,timestamp:(new Date).toISOString(),url:window.location.href,userAgent:navigator.userAgent,environment:r.getEnvironment()})}finally{z(!1)}};return e.jsxs("div",{className:"min-h-screen flex flex-col bg-background",children:[e.jsx("h1",{className:"sr-only",children:"TradeLine 24/7 Authentication"}),e.jsx("div",{className:"flex-1 container py-8 px-4 flex items-center justify-center",children:e.jsxs(i,{className:"w-full max-w-md",children:[e.jsxs(o,{className:"text-center",children:[e.jsx(l,{className:"text-2xl",children:"Welcome to TradeLine 24/7"}),e.jsx(c,{children:"Sign in to your account or create a new one"})]}),e.jsx(d,{children:e.jsxs(x,{defaultValue:"signin",className:"space-y-4",children:[e.jsxs(f,{className:"grid w-full grid-cols-2",children:[e.jsx(y,{value:"signin",children:"Sign In"}),e.jsx(y,{value:"signup",children:"Sign Up"})]}),V&&e.jsx(u,{variant:"destructive",children:e.jsx(m,{children:V})}),I&&e.jsx(u,{children:e.jsx(m,{children:I})}),e.jsx(j,{value:"signin",children:e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),S&&N){T(!0),C(null);try{const{error:e}=await(async(e,s)=>{if(!t)throw new Error("Supabase is disabled in this environment.");const{error:r}=await a.auth.signInWithPassword({email:e,password:s});return{error:r}})(S,N);e?(e.message.includes("Invalid login credentials")?C("Invalid email or password. Please check your credentials."):C(e.message),T(!1)):R(n.dashboard)}catch(s){C(s.message||"An error occurred during sign in"),T(!1)}}else C("Please fill in all fields")},className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"signin-email",children:"Email"}),e.jsx(g,{id:"signin-email",type:"email",placeholder:"Enter your email",value:S,onChange:e=>k(e.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"signin-password",children:"Password"}),e.jsx(g,{id:"signin-password",type:"password",placeholder:"Enter your password",value:N,onChange:e=>P(e.target.value),required:!0})]}),e.jsxs(p,{type:"submit",variant:"success",className:"w-full",disabled:B,children:[B&&e.jsx(w,{className:"mr-2 h-4 w-4 animate-spin"}),"Sign In"]})]})}),e.jsx(j,{value:"signup",children:e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),S&&N&&A){T(!0),C(null),D(null);try{const{error:e}=await(async(e,s,r)=>{const n=await _(s);if(!n.isValid)throw new Error(n.message||"Password does not meet security requirements");if(n.isBreached)throw new Error("This password appears in known data breaches. Please choose a different password.");const i=`${window.location.origin}/`;if(!t)throw new Error("Supabase is disabled in this environment.");const{error:o}=await a.auth.signUp({email:e,password:s,options:{emailRedirectTo:i,data:{display_name:r}}});return{error:o}})(S,N,A);e?(e.message.includes("already registered")?C("This email is already registered. Please sign in instead."):C(e.message),T(!1)):(D("Account created successfully! Please check your email to verify your account."),T(!1),k(""),P(""),E(""))}catch(s){C(s.message||"An error occurred during sign up"),T(!1)}}else C("Please fill in all fields")},className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"signup-name",children:"Display Name"}),e.jsx(g,{id:"signup-name",type:"text",placeholder:"Enter your name",value:A,onChange:e=>E(e.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"signup-email",children:"Email"}),e.jsx(g,{id:"signup-email",type:"email",placeholder:"Enter your email",value:S,onChange:e=>k(e.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"signup-password",children:"Password"}),e.jsx(g,{id:"signup-password",type:"password",placeholder:"Create a strong password",value:N,onChange:e=>H(e.target.value),required:!0,minLength:8}),N&&e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Strength: "}),e.jsxs("span",{className:"font-medium "+("Very strong"===U||"Strong"===U?"text-[hsl(142,85%,25%)]":"Good"===U?"text-amber-800":"text-red-700"),children:[U,W&&e.jsx(w,{className:"inline w-3 h-3 ml-1 animate-spin"})]})]}),G&&e.jsx("div",{className:"text-xs text-red-700 font-medium",children:"⚠️ This password appears in known data breaches. Please choose a different password."}),N.length>=8&&!G&&"Too short"!==U&&e.jsx("div",{className:"text-xs text-[hsl(142,85%,25%)]",children:"✓ Password meets security requirements"}),("Too short"===U||"Weak"===U||"Too weak"===U)&&e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:"Use 8+ characters with uppercase, lowercase, numbers, and symbols"})]})]}),e.jsxs(p,{type:"submit",variant:"success",className:"w-full",disabled:B,children:[B&&e.jsx(w,{className:"mr-2 h-4 w-4 animate-spin"}),"Create Account"]})]})})]})})]})}),e.jsx(v,{})]})};export{S as default};
